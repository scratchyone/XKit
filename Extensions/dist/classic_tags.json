{"id":"classic_tags","script":"//* TITLE Tag Tracking+ **//\n//* VERSION 1.6.12 **//\n//* DESCRIPTION Shows your tracked tags on your sidebar **//\n//* DEVELOPER new-xkit **//\n//* FRAME false **//\n//* BETA false **//\n\nXKit.extensions.classic_tags = new Object({\n\n\trunning: false,\n\tslow: true,\n\tapiKey: XKit.api_key,\n\tmax_posts_per_tag: 10,\n\ttagcounts: {},\n\tcount_update_handle: null,\n\n\tpreferences: {\n\t\t\"sep-1\": {\n\t\t\ttext: \"Tag Search\",\n\t\t\ttype: \"separator\"\n\t\t},\n\t\t\"show_new_notification\": {\n\t\t\ttext: \"Show a [new] indicator in the tag search bar\",\n\t\t\tdefault: true,\n\t\t\tvalue: true\n\t\t},\n\t\t\"sep-2\": {\n\t\t\ttext: \"Tags in Sidebar\",\n\t\t\ttype: \"separator\"\n\t\t},\n\t\t\"show_tags_on_sidebar\": {\n\t\t\ttext: \"Show Tags on sidebar\",\n\t\t\tdefault: true,\n\t\t\tvalue: true\n\t\t},\n\t\t\"only_new_tags\": {\n\t\t\ttext: \"Only show tags with new posts\",\n\t\t\tdefault: false,\n\t\t\tvalue: false\n\t\t},\n\t\t\"prepend_sidebar\": {\n\t\t    text: \"Put tags at top of sidebar\",\n\t\t    default: false,\n\t\t    value: false\n\t\t},\n\t\t\"alphabetical_tags\": {\n\t\t\ttext: \"Sort tags alphabetically\",\n\t\t    default: false,\n\t\t    value: false\n\t\t},\n\t\t\"sep-3\": {\n\t\t\ttext: \"Settings\",\n\t\t\ttype: \"separator\"\n\t\t},\n\t\t\"open_in_new_tab\": {\n\t\t\ttext: \"Open the tag results in a new window\",\n\t\t\tdefault: false,\n\t\t\tvalue: false\n\t\t},\n\t\t\"turn_off_warning\": {\n\t\t\ttext: \"Turn off 'Too Many Tracked Tags' warning\",\n\t\t\tdefault: false,\n\t\t\tvalue: false\n\t\t}\n\t},\n\ttypeahead_dropdown: null,\n\ttag_text: null,\n\ttags: [],\n\tplaceholder: null,\n\tsearch_input: null,\n\n\tobserver: new MutationObserver(function(mutations) {\n\t\tconst {classic_tags} = XKit.extensions;\n\t\tconst new_tab = classic_tags.preferences.open_in_new_tab.value;\n\n\t\tmutations.forEach(({addedNodes})=> {\n\t\t\tif (!addedNodes) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\taddedNodes.forEach(addedNode => {\n\t\t\t\tconst container = $(addedNode).filter(classic_tags.typeahead_dropdown);\n\n\t\t\t\tif (container.length === 0) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst $tags = container.find(\"a\");\n\n\t\t\t\t$tags.each(function() {\n\t\t\t\t\tconst $tag = $(this);\n\n\t\t\t\t\t$tag.attr(\"target\", new_tab ? \"_blank\" : \"\");\n\n\t\t\t\t\tconst $name = $tag.find(classic_tags.tag_text);\n\t\t\t\t\tconst count = classic_tags.tagcounts[$name.text()];\n\t\t\t\t\tif (count) {\n\t\t\t\t\t\t$name.text(`${$name.text()} (${count})`);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}),\n\n\tget_post_timestamp: function(blog_name, post_id) {\n\t\tvar self = this;\n\t\tvar api_url = \"https://api.tumblr.com/v2/blog/\" + blog_name + \"/posts\" + \"?api_key=\" + self.apiKey + \"&id=\" + post_id;\n\t\tvar promise = $.Deferred();\n\n\t\tfunction fail() {\n\t\t\tconsole.log(\"XKit TagTracker+ Error: Unable to fetch post timestamp for \" + post_id);\n\t\t\tpromise.reject();\n\t\t}\n\n\t\ttry {\n\t\t\tGM_xmlhttpRequest({\n\t\t\t\tmethod: \"GET\",\n\t\t\t\turl: api_url,\n\t\t\t\tonerror: fail,\n\t\t\t\tonload: function(response) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tvar data = JSON.parse(response.responseText);\n\t\t\t\t\t\tvar post = data.response.posts[0];\n\t\t\t\t\t\tpromise.resolve(post.timestamp);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tfail();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (e) {\n\t\t\tfail();\n\t\t}\n\n\t\treturn promise;\n\t},\n\n\tget_unread_post_count_for_tag: function(tag_name) {\n\t\tvar self = this;\n\t\tvar api_url = \"https://api.tumblr.com/v2/tagged?limit=\" + self.max_posts_per_tag + \"&tag=\" + tag_name + \"&api_key=\" + self.apiKey;\n\t\tvar promise = $.Deferred();\n\n\t\tfunction fail() {\n\t\t\tconsole.log(\"XKit TagTracker+ Error: Unable to fetch unread tag counts for \" + tag_name);\n\t\t\tpromise.reject();\n\t\t}\n\n\t\ttry {\n\t\t\tGM_xmlhttpRequest({\n\t\t\t\tmethod: \"GET\",\n\t\t\t\turl: api_url,\n\t\t\t\tonerror: fail,\n\t\t\t\tonload: function(response) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tvar data = JSON.parse(response.responseText);\n\t\t\t\t\t\tvar newest_post_seen = XKit.storage.get(\"classic_tags\", \"lastseen#\" + tag_name);\n\t\t\t\t\t\tif (!newest_post_seen) {\n\t\t\t\t\t\t\tpromise.resolve(data.response.length);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvar newer_posts_count = data.response.map(function(post) {\n\t\t\t\t\t\t\treturn post.timestamp;\n\t\t\t\t\t\t}).filter(function(timestamp) {\n\t\t\t\t\t\t\treturn timestamp > newest_post_seen;\n\t\t\t\t\t\t}).length;\n\n\t\t\t\t\t\tpromise.resolve(newer_posts_count);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tfail();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} catch (e) {\n\t\t\tfail();\n\t\t}\n\n\t\treturn promise.then(function(count) {\n\t\t\tif (count === self.max_posts_per_tag) { count += \"+\"; }\n\t\t\tself.tagcounts[tag_name] = count;\n\t\t\treturn count;\n\t\t});\n\t},\n\n\tupdate_tag_timestamp: async function() {\n\t\ttry {\n\t\t\tconst current_tag = decodeURIComponent(location.pathname.split('/')[2].replace(/\\+/g, ' '));\n\t\t\tconst newest_post = $(\"[data-id]\").first();\n\n\t\t\tif (newest_post != null) {\n\t\t\t\tconst post = await XKit.interface.react.post(newest_post);\n\n\t\t\t\treturn this.get_post_timestamp(post.owner, post.id).then(function(timestamp) {\n\t\t\t\t\tXKit.storage.set(\"classic_tags\", \"lastseen#\" + current_tag, timestamp);\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.log(\"XKit TagTracker+ Error: Couldn't find newest post timestamp on /tagged\");\n\t\t\treturn $.Deferred().resolve();\n\t\t}\n\t},\n\n\tupdate_tag_counts: function(next_update) {\n\t\tvar self = this;\n\t\tvar new_post_count_promises = [];\n\n\t\tfunction fetch_count(tag_name) {\n\t\t\tvar promise = self.get_unread_post_count_for_tag(tag_name);\n\t\t\tnew_post_count_promises.push(promise);\n\t\t\treturn promise;\n\t\t}\n\n\t\tif (self.preferences.show_tags_on_sidebar.value) {\n\t\t\tvar list = $(\"#xtags\");\n\t\t\tvar list_hidden = list.hasClass(\"hidden\");\n\n\t\t\t$(\".xtag\").each(function() {\n\t\t\t\tvar li = $(this);\n\t\t\t\tvar anchor = li.find(\".result_link\");\n\t\t\t\tvar tag_name = anchor.attr(\"data-tag-result\");\n\n\t\t\t\tif (parseInt(self.tagcounts[tag_name], 10) === self.max_posts_per_tag) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tfetch_count(tag_name).then(function(count) {\n\t\t\t\t\tif (!count) { return; }\n\n\t\t\t\t\tif (list_hidden) {\n\t\t\t\t\t\tlist.removeClass(\"hidden\");\n\t\t\t\t\t\tlist_hidden = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tli.removeClass(\"hidden\");\n\t\t\t\t\tvar existing_count = anchor.find(\".count\");\n\t\t\t\t\tif (existing_count.length) {\n\t\t\t\t\t\texisting_count.text(count);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tanchor.find(\".result_title\").after(`<span class=\"count\">${count}</span>`);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t} else {\n\t\t\tself.tags.tags.forEach(tag => {\n\t\t\t\tvar count = self.tagcounts[tag.name];\n\n\t\t\t\tif (!count || parseInt(count, 10) < self.max_posts_per_tag) {\n\t\t\t\t\tfetch_count(tag.name);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (self.preferences.show_new_notification.value) {\n\t\t\t$.when.apply($, new_post_count_promises).then(function() {\n\t\t\t\tvar any_new_posts = Array.prototype.some.call(arguments, function(count) { return !!count; });\n\t\t\t\tself.search_input.attr(\"placeholder\", `${self.placeholder}${(any_new_posts ? \" [New]\" : \"\")}`);\n\t\t\t});\n\t\t}\n\n\t\tself.count_update_handle = setTimeout(self.update_tag_counts.bind(self, next_update * 1.5), next_update);\n\t},\n\n\trun: function() {\n\t\tXKit.tools.init_css(\"classic_tags\");\n\n\t\tvar where = XKit.interface.where();\n\n\t\tif (!where.dashboard && !where.tagged) {\n\t\t\treturn;\n\t\t}\n\n\t\tXKit.css_map.getCssMap().then(() => {\n\t\t\tthis.typeahead_dropdown = XKit.css_map.keyToCss(\"typeaheadDropdown\");\n\t\t\tthis.tag_text = XKit.css_map.keyToCss(\"tagText\");\n\n\t\t\tif (where.tagged) {\n\t\t\t\tthis.update_tag_timestamp().then(() => this.show());\n\t\t\t} else {\n\t\t\t\tthis.show();\n\t\t\t}\n\t\t}).catch(e => console.error(\"Can't run Classic Tags:\" + e.message));\n\t},\n\n\tshow: async function() {\n\t\tconst where = XKit.interface.where();\n\t\tif (!where.dashboard && !where.tagged) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst $container = $(XKit.css_map.descendantSelector(\"formContainer\", \"targetWrapper\"));\n\t\tconst $sidebar = $(XKit.css_map.keyToCss(\"sidebar\")).find(\"aside\");\n\n\t\tthis.search_input = $container.find(\"input[name='q']\");\n\t\tthis.placeholder = this.search_input.attr(\"placeholder\");\n\n\t\tthis.tags = await XKit.tools.async_add_function(async () => {\n\t\t\tconst result = await window.tumblr.apiFetch(\"/v2/user/followed_tags\", { method: \"GET\", queryParams: { limit: 20 } });\n\t\t\tconst tag_expression = new RegExp(/^#?(.+)/);\n\n\t\t\treturn {\n\t\t\t\ttags: result.response.timeline.elements.map(tag => {\n\t\t\t\t\tconst match = tag.tagName.match(tag_expression);\n\t\t\t\t\tconst tag_name = match != null ? match[1] : tag.tagName;\n\n\t\t\t\t\treturn ({\n\t\t\t\t\t\tname: tag_name,\n\t\t\t\t\t\tlink: tag.links.tap.href\n\t\t\t\t\t});\n\t\t\t\t}),\n\t\t\t\tmore: result.response.timeline.links.next != null\n\t\t\t};\n\t\t});\n\n\t\tvar extra_classes = \"\";\n\t\tvar m_html = \"\";\n\n\t\tif (this.preferences.alphabetical_tags.value) {\n\t\t\tthis.tags.tags.sort((tagA, tagB) => (tagA.name > tagB.name) ? 1 : -1);\n\t\t}\n\n\t\tthis.tags.tags.forEach(tag => {\n\n\t\t\tif (location.href === tag.link) {\n\t\t\t\textra_classes = \"selected\";\n\t\t\t} else {\n\t\t\t\textra_classes = \"\";\n\t\t\t}\n\n\t\t\tif (this.preferences.only_new_tags.value) {\n\t\t\t\textra_classes += \" hidden\";\n\t\t\t}\n\n\t\t\tconst svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 18 18' width='18' height='18' fill='rgba(var(--white-on-dark), 0.65)'><path d='M 0 0 L 0 8 L 11 18 L 18 10 L 8 0 L 0 0 z M 3.5 2 A 1.5 1.5 0 0 1 5 3.5 A 1.5 1.5 0 0 1 3.5 5 A 1.5 1.5 0 0 1 2 3.5 A 1.5 1.5 0 0 1 3.5 2 z '></path></svg>`;\n\n\t\t\tm_html += `\n\t\t\t\t<div class=\"xtag ${extra_classes}\">\n\t\t\t\t\t<a class=\"result_link\" href=\"${tag.link}\" data-tag-result=\"${tag.name}\" ${(this.preferences.open_in_new_tab.value ? \"target='_blank'\" : \"\")}>\n\t\t\t\t\t\t<div class=\"hide_overflow\">\n\t\t\t\t\t\t\t<span class=\"result_icon\">${svg}</span>\n\t\t\t\t\t\t\t<span class=\"result_title\">${tag.name}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t`;\n\n\t\t});\n\n\t\tif (m_html !== \"\" && this.preferences.show_tags_on_sidebar.value) {\n\t\t\tif (this.tags.more === true && this.preferences.turn_off_warning.value !== true) {\n\t\t\t\tm_html += \"<div class=\\\"classic-tags-too-much-tags-error\\\"><b>Too Many Tracked Tags:</b><br> Only 20 tracked tags will be listed here.</div>\";\n\t\t\t}\n\n\t\t\tconst extra_class = this.preferences.only_new_tags.value ? \"hidden\" : \"\";\n\t\t\tm_html = `\n\t\t\t\t<div class=\"${XKit.css_map.keyToClasses(\"sidebarItem\").join(\" \")} ${extra_class}\" id=\"xtags\">\n\t\t\t\t\t<div class=\"${XKit.css_map.keyToClasses(\"sidebarTitle\").join(\" \")}\">Tracked Tags</div>\n\t\t\t\t\t${m_html}\n\t\t\t\t</div>\n\t\t\t`;\n\n\t\t\tif (this.preferences.prepend_sidebar.value === true) {\n\t\t\t\t$sidebar.prepend(m_html);\n\t\t\t} else {\n\t\t\t\t$sidebar.append(m_html);\n\t\t\t}\n\t\t}\n\n\t\tvar target = $container[0];\n\t\tthis.observer.observe(target, {\n\t\t\tsubtree: true,\n\t\t\tchildList: true\n\t\t});\n\n\t\tthis.update_tag_counts(2 * 60 * 1000); //start at 2 minutes\n\t},\n\n\tdestroy: function() {\n\t\tXKit.tools.remove_css(\"classic_tags\");\n\t\t$(\"#xtags\").remove();\n\t\tXKit.extensions.classic_tags.search_input.attr(\"placeholder\", XKit.extensions.classic_tags.placeholder);\n\t\tXKit.extensions.classic_tags.observer.disconnect();\n\t\tclearTimeout(XKit.extensions.classic_tags.count_update_handle);\n\t}\n\n});\n","file":"found","server":"up","errors":false,"icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpGNzdGMTE3NDA3MjA2ODExODA4MzkyMjM2MzU5MTQ4NCIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpGRUZGRjZFNTM4QzYxMUUzQTFDQUFDOThEMTlDRUY3OSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpGRUZGRjZFNDM4QzYxMUUzQTFDQUFDOThEMTlDRUY3OSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZCN0YxMTc0MDcyMDY4MTE4MDgzOTIyMzYzNTkxNDg0IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkY3N0YxMTc0MDcyMDY4MTE4MDgzOTIyMzYzNTkxNDg0Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+QJeL+wAAAlRJREFUeNrsVktPE1EU/qaPQAoSCXsMGEiMiQuE0vLQKo8YN/4BQdCVLjQhcevCPX/BDStdsCFBbICIKZRCeDYh1No2PIohGlEaZopQ6r3TUefe3hmnJrPS05Nmbufc7+v5zj1nRpooz8NOc8Bm+0/wR3NJTpsJYDeBxIrUc4DvX3B2DMkN5KiEzjIcJRAdxGkGgQSNSb/E5hMaY8WkYA3TBz2fDUNnfTjfjsvD9Poojjm/tSKTDPResPwJ9l4hE2VCW4P4OKLhVjSgLQxur9Dph3HVNp9h4zEWbkPZ1alZha405BTC135yzIPfXuQOyQW9Fywnq9dEvDNWUDe6diAnMR+gS089/LPgEHifqmVqcHOLfp98w+4IqonozQJZSXnfNsJzEb5prR6RbuMiT9cxBDeSlkpHOGYuoaIR3gm6JDkZcThIo+nd6gAoQyAOOYHILU2r1klwUAXnT9HXJascZHMghmwKkV6NwzspOkVcTdb7cbhewiS7HsNxGit3VY4L8E4VFfndldIeOJ1rgh9DV+GshE9FPz1EuNN42HUsm6GHmgxu5JHLaKectIse0/Xr7FvSXRS8OkBBm8e05UofE8ZnYD5hio/Z2n3IMbS8huuctlQ+cBmwe/whM4JwRxH6e3jf0AxoKvegJPg/8fcSRR9BSdJGI+WlZA+Q3RJoyBOYNL2eIP6cwrWMw+lRyR6K0QUEhdY3sgW1b7df4GAOdUO/0ZUUjJQQT1OTDPbHsD9KLz4F6TNu4ymyO6bTdPGOvW92pRX5HyWw/b3IbS/BDwEGAPg3rFrD0wEGAAAAAElFTkSuQmCC","css":".xtag {\n\tborder-top: 1px solid rgba(var(--white-on-dark), 0.07);\n\tposition: relative;\n\tpadding: 0;\n}\n\n.xtag a {\n\ttext-decoration: none;\n}\n\n.xtag.hidden {\n\tdisplay: none !important;\n\tvisibility: hidden !important;\n}\n\n.xtag.selected, .xtag:hover {\n\tbackground-color: rgba(var(--white-on-dark), 0.07);\n}\n\n.xtag .hide_overflow {\n\twhite-space: nowrap;\n\toverflow: hidden;\n\ttext-overflow: ellipsis;\n}\n\n.xtag .result_title {\n\twidth: 88% !important;\n\tcolor: rgba(var(--white-on-dark), 0.65);\n\tpadding-left: 3px;\n\tfont-weight: 700;\n\tposition: absolute;\n\tline-height: 30px;\n}\n\n.xtag .result_icon {\n\tdisplay: inline-block;\n\theight: 18px;\n\tpadding: 6px 6px 6px 13px;\n}\n\n.xtag a .count {\n\ttop: 8px;\n\tposition: absolute;\n\tright: 10px;\n\tcolor: rgba(var(--white-on-dark), 0.65);\n\tfont-weight: 400;\n}\n\n.result_sub_title {\n\tfont-weight: 700 !important;\n\tpadding: 9px 0;\n}\n\n.classic-tags-too-much-tags-error {\n\tfont-size: 13px;\n\ttext-align: center;\n\tpadding: 10px 10px;\n\tmargin-top: 3px;\n\tbackground: rgba(0, 0, 0, 0.06);\n\tcolor: rgba(var(--white-on-dark), 0.4);\n}\n","title":"Tag Tracking+","description":"Shows your tracked tags on your sidebar","developer":"new-xkit","version":"1.6.12","frame":"false","beta":"false","slow":"false"}